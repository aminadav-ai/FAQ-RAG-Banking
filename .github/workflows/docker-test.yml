name: Run FastAPI + ChromaDB integration test

on:
  push:
    branches: [main]
  pull_request:

jobs:
  integration-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Build and start services via docker-compose
        run: docker-compose up -d --build

      - name: Wait for ChromaDB to be ready
        run: |
          echo "Waiting for ChromaDB..."
          for i in {1..10}; do
            curl -s http://localhost:8001/api/v2/heartbeat && break
            echo "Retrying ChromaDB ($i)..."
            sleep 3
          done

      - name: Wait for FastAPI to be ready
        run: |
          echo "Waiting for FastAPI..."
          for i in {1..10}; do
            curl -s http://localhost:8000/docs && break
            echo "Retrying FastAPI ($i)..."
            sleep 3
          done

      - name: Send test GET or POST request to FastAPI
        run: |
          echo "Testing GET..."
          curl -s -X GET http://localhost:8000/your-endpoint || exit 1

          # Пример POST:
          # curl -s -X POST http://localhost:8000/query -H "Content-Type: application/json" -d '{"question": "hello"}'

      - name: Shut down containers
        if: always()
        run: docker-compose down --volumes

