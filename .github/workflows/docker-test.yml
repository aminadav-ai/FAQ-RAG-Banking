name: test-docker

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  docker-test:
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v3

      - name: 🐳 Cache Docker layers
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: 🔧 Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 🛠️ Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          tags: faq-rag-banking:test
          load: true
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: 🚀 Run container
        run: |
          docker run -d -p 8000:8000 --name faq-test faq-rag-banking:test

      - name: ⏳ Wait for API to be ready
        run: |
          for i in {1..30}; do
            if curl -s http://localhost:8000/docs > /dev/null; then
              echo "✅ API is up"
              exit 0
            fi
            echo "⏳ Waiting for API..."
            sleep 3
          done
          echo "❌ API did not start in time"
          exit 1

      - name: 🧪 Test API endpoint
        run: |
          curl --fail http://localhost:8000/docs || (echo "❌ API is not responding" && exit 1)

      - name: 🐳 Show container logs
        run: docker logs faq-test

      - name: 🧹 Stop container
        run: docker stop faq-test && docker rm faq-test

